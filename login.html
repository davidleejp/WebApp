<html lang="ja">

<head>
    <title>Login</title>
    <meta name="charset" content="UTF-8" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport"
        content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <link rel="stylesheet" href="./style/main.css" />
    <link rel="manifest" href="./manifest.json" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        // SW登録
        var appVerb = '3.6';
        var swPath = './service-worker.js';
        const storeageName = 'sw_version';
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(swPath).then(reg => {
                console.log('Service Worker Registered');
                if (!getLocalCache(storeageName)) {
                    updateLocalCache(storeageName, appVerb);
                } else if (getLocalCache(storeageName) !== appVerb) {
                    // reg.update().then(function () {
                    //     updateLocalCache(storeageName, appVerb)
                    // });
                    this.skipWaiting(reg).then(() => {
                        updateLocalCache(storeageName, appVerb);
                        window.location.reload();
                    });
                } else {
                    // do nothing
                }
            });
        }

        function skipWaiting(reg) {
            const worker = reg.waiting
            if (!worker) {
                return Promise.resolve()
            }
            return new Promise((resolve, reject) => {
                const channel = new MessageChannel()
                channel.port1.onmessage = (event) => {
                    if (event.data.error) {
                        reject(event.data.error)
                    } else {
                        resolve(event.data)
                    }
                }
                worker.postMessage({ type: 'skip-waiting', verb: appVerb }, [channel.port2])
            })
        }

        function updateLocalCache(key, val) {
            localStorage.setItem(key, val);
        }

        function getLocalCache(key) {
            return localStorage.getItem(key);
        }

        $(function () {
            // login 処理
            $('#btnLogin').click(function () {
                let userName, userPwd = '';
                userName = $('#txtUserName').val();
                userPwd = $('#txtUserPwd').val();
                console.log('username:' + userName + ', userpwd:' + userPwd);
                return true;
            })
        })
    </script>
</head>

<body>
    <div class="header">現場支援システム</div>
    <div class="content">
        <form action="./home.html" method="GET" id="frmLogin" name="frmLogin">
            <ul class="list">
                <li>
                    <input type="text" id="txtUserName" name="userName" class="text" maxlength="32" />
                </li>
                <li>
                    <input type="password" id="txtUserPwd" name="userPwd" class="text" maxlength="16" />
                </li>
                <li>
                    <button class="btn" id="btnLogin" type="submit">ログイン</button>
                </li>
                <li>
                    <a href="./forgot_pwd.html" class="info">パスワードを忘れた場合</a>
                </li>
            </ul>

        </form>
    </div>
    <div class="footer"></div>
</body>

</html>